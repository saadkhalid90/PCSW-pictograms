<!DOCTYPE html>
<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<style id="jsbin-css">

	body p {
		font-family: sans-serif;
	}

	.labelP {
		text-align: right;
	}

	.textCategory {
		font-weight: bold;
	}

	.labelDiv {
		width: 125px;
		margin-right: 5px;
	}




	</style>
</head>

<body>
</body>

<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
	d3.csv('pictogramBarData.csv', function(error, data){

		let iconPathArray = ["M318.237,553c0,0,17.7-176.3,53.8-220.6c-6.399,16.7-8,34.1-6.199,53.7c1.5,16.8,7.699,30.2,10.699,46.7    c-6.699,41.7-32.699,138.6-66.399,188.6c-20.601,30.601,9.899,29.301,54.8,21.101l24.5,270.1c0,47.2,44.8,47.2,44.8-0.2    L449.338,625c5.6-1.601,9.6-2.8,11.3-3.3c1.7,0.5,5.7,1.699,11.3,3.3l15,287.5c0,47.399,43.799,47.399,43.799,0.2l24.5-270.101    c10,1.8,19.4,3.3,27.701,4.2v153.3c0,10.9,8.9,19.8,19.799,19.8h59c10.9,0,19.801-8.899,19.801-19.8v-167.7    c0-10.899-8.9-19.8-19.801-19.8h-9.5v-41.2c0-1.8-0.299-3.5-0.699-5.199c1.9-4.101,2.9-9,2.9-14.801    c-0.301-5.199-0.701-10.399-1.1-15.5c-4.602-59.399-12.102-119-25-176.899c-8-36.3-15.602-74.8-35.701-105.9    c-17.9-27.7-41.699-37.1-68.4-45.4c-12-3.7-24.898,2.7-29.1,14.6c-7.4,20.8-18.6,57-26.2,82.3c-2.5,8.4-14.4,8.4-16.9,0    c-7.699-25.3-18.899-61.5-26.199-82.3c-4.2-11.9-17.101-18.4-29.101-14.6c-26.7,8.3-50.5,17.7-68.399,45.4    c-20.101,31.1-27.601,69.5-35.7,105.9c-12.8,58-20.3,117.5-25,176.899c-0.4,5.2-0.8,10.301-1.1,15.5    C266.638,591.3,318.237,590.899,318.237,553z M549.038,332.4c36.1,44.3,53.801,220.6,53.801,220.6c0,10.3,3.799,17.8,9.398,22.5    v37h-6.799c-31-51.9-54.5-140.4-60.801-179.7c3-16.5,9.201-29.9,10.701-46.7C557.038,366.5,555.438,349.1,549.038,332.4z","M402.737,161.9c15.5,13.5,35.8,36.4,57.9,36.4c22.099,0,42.4-22.9,57.9-36.4c15.1,7.9,37.199,15.8,58.301,6.5    c-4.301-11.4-7.9-23.2-10.9-35c-8.1-31.7-5.1-64-26.201-91.2c-19-24.5-48.6-42.2-79.099-42.2c-30.5,0-60.101,17.6-79.101,42.2    c-21.1,27.2-18,59.5-26.199,91.2c-3,11.8-6.601,23.6-10.9,35C365.438,177.6,387.638,169.8,402.737,161.9z"]

		// convert percentages to numbers
		data.forEach(d => {
			d.Percentage = + d.Percentage;
		})
		// sort descending
		data.sort(function(a, b){
				return b.Percentage - a.Percentage
		});
		console.log(data);

		d3.select('body')
			.selectAll('.categoryRow')
			.data(data)
			.enter()
			.append('div')
			.classed('categoryRow', true)
			.style('display', 'flex');


		d3.selectAll('div.categoryRow')
			.append('div')
			.attr('class', 'labelDiv')
			.html(function(d){
				return `<p class = labelP><span class = "textCategory"> ${d.Category} </span class = textPerc><span> ${d.Percentage}% </span></p>`
			})


		let nIcons = 20;
		let iconStep = 100/nIcons;
		let inputDomain = [0, nIcons]
		let outputRange = [0, 100]

		var iconScale = d3.scaleLinear()
			.domain(inputDomain)
			.range(outputRange);

		let iconArr = d3.range(1, nIcons + 1);

		let firstTrue = 0;

		let iconCol = 'blue';
		let iconColBG = '#E0E0E0'

		data.forEach(datum => {
			datum.data = [];
			iconArr.forEach(iconArrEntry => {
				if (iconScale(iconArrEntry) > datum.Percentage){
					firstTrue = firstTrue + 1;
				}
				datum.data.push({
					index: iconArrEntry,
					category: datum.Category,
					maxVal: iconScale(iconArrEntry),
					greater: iconScale(iconArrEntry) > datum.Percentage,
					iconType: (firstTrue == 1) ? 'split' : 'normal',
					SqSplitPathData: (firstTrue != 1) ? [{
						index: iconArrEntry,
						category: datum.Category,
						color: iconScale(iconArrEntry) > datum.Percentage ? iconColBG : iconCol,
						x: 0,
						width:100
					}] :
					[{
						index: iconArrEntry,
						category: datum.Category,
						color: iconCol,
						x: 0,
						width: 100 - (((iconScale(iconArrEntry) - datum.Percentage)/iconStep) * 100)
					},
					{
						index: iconArrEntry,
						category: datum.Category,
						color: iconColBG,
						x: 100 - (((iconScale(iconArrEntry) - datum.Percentage)/iconStep) * 100),
						width: 100
					}]
				});

			})
			firstTrue = 0;
		})


		let iconDiv = d3.selectAll('div.categoryRow')
			.append('div')
			.attr('class', 'iconDiv')
			.style('display', 'flex')
			.style('align-items', 'center');

		///////////////////////////
		// icon specific options //
		///////////////////////////
		let iconWidth = 30;
		let iconHeight = 30;
		let vbWidth = 948.075;
		let vbHeight = 948.075;

		iconDiv.selectAll('div.iconHolder')
					.data(d => d.data)
					.enter()
					.append('div')
					.attr('width', iconWidth)
					.attr('height', iconHeight)
					.classed('iconHolder', true)

		let clipPathSelection = d3.selectAll('.iconHolder')
			.append('svg')
			.attr('width', iconWidth)
			.attr('height', iconHeight)
			.attr("viewBox", `0 0 ${vbWidth} ${vbHeight}`)
			.append("clipPath")
			.attr("class", "clip")
			.attr('id', d => `icon${d.index}-${d.category.replace(" ", "")}`);

		iconPathArray.forEach(d => {
			clipPathSelection.append('path')
											.attr('d', d)
											.attr('fill', 'grey');
		})

		console.log(d3.selectAll('.iconHolder').select('svg').data());


		d3.selectAll('.iconHolder').select('svg')
						.selectAll('rect')
						.data(d => d.SqSplitPathData)
						.enter()
						.append('rect')
						.attr('width', d => d.width + "%")
						.attr('x', d => d.x + "%")
						.style('fill', d => d.color)
						.style('fill-opacity', 0.9)
						.attr("clip-path", function(d, i) { return `url(#icon${d.index}-${d.category.replace(" ", "")})`; })
						.style("clip-path", function(d, i) { return `url(#icon${d.index}-${d.category.replace(" ", "")})`; });

	})
</script>
