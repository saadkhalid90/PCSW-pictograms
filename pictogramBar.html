<!DOCTYPE html>
<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,700" rel="stylesheet">
	<style id="jsbin-css">

	body, html {
		font-family: 'Rubik', sans-serif;
Ã¥	}

	.chartTitle {
		margin-left: 170px;
		font-weight: 300;
	}

	.chartTitle, .labelP {
		color: #455A64;
	}

	.labelP {
		text-align: right;
	}

	.textCategory {
		font-weight: 500;
	}

	.labelDiv {
		width: 160px;
		margin-right: 15px;
	}

	</style>
</head>

<body>
	<h1 class="chartTitle">Employment Rate</h1>
	<div class="chart"></div>
</body>

<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
	d3.csv('pictogramBarData.csv', function(error, data){

		let iconPathArray =  ["M880.2,768c3.3,9.8,5.9,22.2,7.8,37.2c2,15,2.9,30.2,2.9,45.5c0,15.3-1.2,29.8-3.4,43.5c-2.3,13.7-5.7,24.1-10.3,31.3c-3.2,4.6-12.4,9.3-27.4,14.2c-15,4.9-33.7,9.8-56.2,14.7c-22.5,4.9-47.4,9.6-74.8,14.2c-27.4,4.6-54.9,8.5-82.6,11.7c-27.7,3.3-54.3,5.7-79.7,7.3c-25.4,1.7-47.6,2.5-66.5,2.5c-18.9,0-40.4-1-64.6-2.9c-24.1-2-49.1-4.4-74.8-7.3c-25.7-3-51.2-6.4-76.3-10.3c-25.1-3.9-47.9-8-68.5-12.2c-20.5-4.2-38-8.2-52.3-11.7c-14.3-3.6-23.5-7-27.4-10.3c-6.5-5.2-11.6-21-15.2-47.4c-3.6-26.4-2.2-60.8,4.4-103.2c3.9-23.4,13.7-41.4,29.3-53.8c15.6-12.4,33.9-22.1,54.8-29.3c20.9-7.2,42.6-13.7,65.1-19.6c22.5-5.9,42.2-14.4,59.2-25.5c12.4-7.8,22.2-15.3,29.3-22.5c7.2-7.2,12.4-14.2,15.6-21c3.3-6.9,5.4-13.9,6.4-21.1c1-7.2,1.2-15,0.5-23.5l-86.1-11.7c-11.7-8.5-22.2-20.9-31.3-37.2c-7.8-13.7-14.8-32.5-21-56.2c-6.2-23.8-9.3-54.6-9.3-92.4c0-31.3,1.6-64.7,4.9-100.3c3.3-35.5,11.2-69.4,24-101.7c12.7-32.3,31.6-61.3,56.7-87c25.1-25.7,59.5-45.1,103.2-58.2c13-4.6,25.8-7.7,38.1-9.3c12.4-1.6,24.5-2.8,36.2-3.4c6.5-0.7,13-1,19.6-1H531c32.6,0,61.5,6.5,86.6,19.6c25.1,13,47.1,30,66,50.8c18.9,20.9,34.9,44.7,47.9,71.4c13,26.7,23.3,53.5,30.8,80.2c7.5,26.7,12.7,52.6,15.6,77.7c2.9,25.1,4.1,46.5,3.4,64.1c-2,27.4-6.4,52-13.2,73.9c-6.8,21.8-13.8,40.6-21,56.2c-8.5,18.3-17.9,34.6-28.4,48.9L623,568.5c-0.7,8.5-0.2,17.1,1.5,25.9c1.6,8.8,5.1,17.4,10.3,25.9c5.2,8.5,12.7,16.6,22.5,24.4c9.8,7.8,22.5,14.7,38.1,20.6c15.6,6.5,33.1,12.4,52.3,17.6c19.2,5.2,37.8,11.2,55.8,18.1c17.9,6.8,33.9,15.5,47.9,25.9C865.4,737.3,875,751,880.2,768 M506.6,925.5c3.3,0,8.2-2.1,14.7-6.4c6.5-4.2,13-9.3,19.6-15.1c6.5-5.9,12.2-11.7,17.1-17.6c4.9-5.9,7.3-10.4,7.3-13.7c0-3.9-1-10.8-2.9-20.5c-2-9.8-4.2-20.5-6.9-32.3c-2.6-11.7-5.2-23.2-7.8-34.2c-2.6-11.1-4.9-20.2-6.9-27.4c6.5-5.2,12.2-11.1,17.1-17.6c4.9-6.5,7.3-13.1,7.3-19.6c0-5.2-1.8-10.4-5.4-15.6c-3.6-5.2-7.7-10.1-12.2-14.7c-5.2-4.6-11.1-9.1-17.6-13.7h-48.9c-5.9,4.6-11.1,9.1-15.6,13.7c-3.9,3.9-7.5,8.6-10.8,14.2c-3.2,5.6-4.9,10.9-4.9,16.1c0,3.3,2.3,8.1,6.9,14.7c4.5,6.5,10.4,13.1,17.6,19.6c-2,5.9-4.4,14.2-7.3,24.9c-2.9,10.7-6.1,22.2-9.3,34.2c-3.3,12.1-6,23.5-8.3,34.2c-2.3,10.8-3.4,18.8-3.4,24c0,3.3,2.5,7.8,7.3,13.7c4.9,5.9,10.8,11.7,17.6,17.6c6.9,5.9,13.7,10.9,20.6,15.1C498.3,923.3,503.3,925.5,506.6,925.5"];
		// convert percentages to numbers

		data.forEach(d => {
			d.Percentage = + d.Percentage;
		})
		// sort descending
		data.sort(function(a, b){
				return b.Percentage - a.Percentage
		});
		console.log(data);

		d3.select('.chart')
			.selectAll('.categoryRow')
			.data(data)
			.enter()
			.append('div')
			.classed('categoryRow', true)
			.style('display', 'flex');


		d3.selectAll('div.categoryRow')
			.append('div')
			.attr('class', 'labelDiv')
			.html(function(d){
				return `<p class = labelP><span class = "textCategory"> ${d.Category} </span class = textPerc><span> ${d.Percentage}% </span></p>`
			})


		let nIcons = 25;
		let iconStep = 100/nIcons;
		let inputDomain = [0, nIcons]
		let outputRange = [0, 100]

		var iconScale = d3.scaleLinear()
			.domain(inputDomain)
			.range(outputRange);

		let iconArr = d3.range(1, nIcons + 1);

		let firstTrue = 0;

		let iconCol = '1565C0';
		let iconColBG = 'E0E0E0';

		data.forEach(datum => {
			datum.data = [];
			iconArr.forEach(iconArrEntry => {
				if (iconScale(iconArrEntry) > datum.Percentage){
					firstTrue = firstTrue + 1;
				}
				datum.data.push({
					index: iconArrEntry,
					category: datum.Category,
					maxVal: iconScale(iconArrEntry),
					greater: iconScale(iconArrEntry) > datum.Percentage,
					iconType: (firstTrue == 1) ? 'split' : 'normal',
					SqSplitPathData: (firstTrue != 1) ? [{
						index: iconArrEntry,
						category: datum.Category,
						color: iconScale(iconArrEntry) > datum.Percentage ? iconColBG : iconCol,
						x: 0,
						width:100
					}] :
					[{
						index: iconArrEntry,
						category: datum.Category,
						color: iconCol,
						x: 0,
						width: 100 - (((iconScale(iconArrEntry) - datum.Percentage)/iconStep) * 100)
					},
					{
						index: iconArrEntry,
						category: datum.Category,
						color: iconColBG,
						x: 100 - (((iconScale(iconArrEntry) - datum.Percentage)/iconStep) * 100),
						width: 100
					}]
				});

			})
			firstTrue = 0;
		})


		let iconDiv = d3.selectAll('div.categoryRow')
			.append('div')
			.attr('class', 'iconDiv')
			.style('display', 'flex')
			.style('align-items', 'center');

		///////////////////////////
		// icon specific options //
		///////////////////////////
		let iconWidth = 25;
		let iconHeight = 25;
		let vbWidth = 1000;
		let vbHeight = 1000;

		iconDiv.selectAll('div.iconHolder')
					.data(d => d.data)
					.enter()
					.append('div')
					.attr('width', iconWidth)
					.attr('height', iconHeight)
					.classed('iconHolder', true)

		let clipPathSelection = d3.selectAll('.iconHolder')
			.append('svg')
			.attr('width', iconWidth)
			.attr('height', iconHeight)
			.attr("viewBox", `0 0 ${vbWidth} ${vbHeight}`)
			.append("clipPath")
			.attr("class", "clip")
			.attr('id', d => `icon${d.index}-${d.category.replace(" ", "")}`);

		iconPathArray.forEach(d => {
			clipPathSelection.append('path')
											.attr('d', d)
											.attr('fill', 'grey');
		})

		console.log(d3.selectAll('.iconHolder').select('svg').data());


		d3.selectAll('.iconHolder').select('svg')
						.selectAll('rect')
						.data(d => d.SqSplitPathData)
						.enter()
						.append('rect')
						.attr('width', d => d.width + "%")
						.attr('x', d => d.x + "%")
						.style('fill', d => d.color)
						.style('fill-opacity', 0.9)
						.attr("clip-path", function(d, i) { return `url(#icon${d.index}-${d.category.replace(" ", "")})`; })
						.style("clip-path", function(d, i) { return `url(#icon${d.index}-${d.category.replace(" ", "")})`; });

	})
</script>
